<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pesquisa de Satisfação - Deck Delivery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 p-4">
<div class="max-w-xl mx-auto bg-white rounded-xl shadow-md p-6">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">Como foi sua entrega?</h1>
    <form id="npsForm" class="space-y-4">
        <div id="perguntas"></div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Enviar Respostas</button>
    </form>
</div>

<script>
    const chavePedido = new URLSearchParams(window.location.search).get('chave');
    const formulario = 'nps_delivery_deck';

    const baseUrl = window.location.hostname !== 'localhost'
        ? 'https://vemprodeck.com.br/dispatch-bot/api/index.php'
        : 'http://localhost/dispatch-bot-api/index.php';

    async function carregarFormulario() {
        let loading;
        try {
            loading = Swal.fire({
                title: 'Carregando...',
                text: 'Por favor, aguarde',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            const check = await axios.post(baseUrl, {
                method: 'FormularioJaRespondido',
                data: { chave_pedido: chavePedido, formulario }
            });

            if (check.data.respondido) {
                Swal.fire('Formulário já respondido', 'Você já respondeu esse formulário. Obrigado!', 'info');
                document.getElementById('npsForm').remove();
                return;
            }

            const response = await axios.post(baseUrl, {
                method: 'ListQuestionsActive',
                data: { formulario }
            });

            Swal.close();

            const perguntas = response.data;
            const container = document.getElementById('perguntas');

            perguntas.forEach(p => {
                const div = document.createElement('div');
                div.className = 'pergunta';
                div.innerHTML = `
            <label class="block font-medium text-gray-700">${p.titulo}</label>
            <small class="block mb-1 text-gray-500">${p.subtitulo || ''}</small>
            ${gerarInput(p)}
          `;
                container.appendChild(div);
            });
        } catch (err) {
            Swal.fire('Erro', 'Erro ao carregar perguntas ou verificar envio.', 'error');
        }
    }

    function gerarInput(p) {
        const name = `resposta_${p.id}`;
        if (p.metodo_resposta === 'nota') {
            return `<input type="number" name="${name}" min="0" max="10" required class="w-full border border-gray-300 rounded px-3 py-2">`;
        }
        if (p.metodo_resposta === 'sim_nao') {
            return `
          <select name="${name}" required class="w-full border border-gray-300 rounded px-3 py-2">
            <option value="">Selecione</option>
            <option value="sim">Sim</option>
            <option value="nao">Não</option>
          </select>`;
        }
        if (p.metodo_resposta === 'upload') {
            return `<input type="file" name="${name}" accept="image/*,video/*" required class="w-full">`;
        }
        return `<input type="text" name="${name}" required class="w-full border border-gray-300 rounded px-3 py-2">`;
    }

    async function uploadArquivo(arquivo, perguntaId) {
        const sufixo = Math.floor(Math.random() * 90 + 10);
        const nomeArquivo = `${chavePedido}-${perguntaId}-${sufixo}`;

        const form = new FormData();
        form.append('file', arquivo);
        form.append('nome', nomeArquivo);
        form.append('method', 'UploadArquivo');

        const response = await axios.post('https://vemprodeck.com.br/upload.php', form, {
            headers: { 'Content-Type': 'multipart/form-data' }
        });

        return response.data.url;
    }

    document.getElementById('npsForm').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const respostas = [];

        for (let [key, value] of formData.entries()) {
            const match = key.match(/^resposta_(\d+)$/);
            if (match) {
                const perguntaId = parseInt(match[1]);

                if (value instanceof File && value.size > 0) {
                    if (value.size > 25 * 1024 * 1024) {
                        Swal.fire('Erro', 'Arquivos devem ter no máximo 25MB.', 'error');
                        return;
                    }
                    const url = await uploadArquivo(value, perguntaId);
                    respostas.push({ pergunta_id: perguntaId, resposta: url });
                } else {
                    respostas.push({ pergunta_id: perguntaId, resposta: value });
                }
            }
        }

        try {
            const response = await axios.post(baseUrl, {
                method: 'CreateRespostas',
                data: { chave_pedido: chavePedido, respostas }
            });

            if (response.data.success) {
                Swal.fire('Obrigado!', 'Suas respostas foram registradas com sucesso.', 'success')
                    .then(() => window.location.reload());
            } else {
                Swal.fire('Erro', response.data.error || 'Erro ao enviar.', 'error');
            }
        } catch (err) {
            Swal.fire('Erro', 'Erro ao enviar respostas.', 'error');
        }
    });

    carregarFormulario();
</script>
</body>
</html>